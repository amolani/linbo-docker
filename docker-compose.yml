# LINBO Docker - Standalone Network Boot & Imaging Solution
# https://github.com/amolani/linbo-docker

services:
  # =============================================================================
  # Init Container - Downloads boot files on first start
  # =============================================================================
  init:
    build:
      context: ./containers/init
      dockerfile: Dockerfile
    container_name: linbo-init
    volumes:
      - linbo_srv_data:/srv/linbo
      - linbo_kernel_data:/var/lib/linuxmuster/linbo
    environment:
      - BOOT_FILES_URL=${BOOT_FILES_URL:-https://github.com/amolani/linbo-docker/releases/latest/download/linbo-boot-files.tar.gz}
      - FORCE_UPDATE=${FORCE_BOOT_UPDATE:-false}
    networks:
      - linbo-net
    restart: "no"

  # =============================================================================
  # TFTP Server - PXE Boot Files
  # =============================================================================
  tftp:
    build:
      context: ./containers/tftp
      dockerfile: Dockerfile
    container_name: linbo-tftp
    ports:
      - "69:69/udp"
    volumes:
      - linbo_srv_data:/srv/linbo:ro
    networks:
      - linbo-net
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "pgrep", "in.tftpd"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # RSYNC Server - Image Synchronization
  # =============================================================================
  rsync:
    build:
      context: ./containers/rsync
      dockerfile: Dockerfile
    container_name: linbo-rsync
    ports:
      - "873:873"
    volumes:
      - linbo_srv_data:/srv/linbo
      - ./config/rsyncd.conf:/etc/rsyncd.conf:ro
      - ./config/rsyncd.secrets:/etc/rsyncd.secrets:ro
    networks:
      - linbo-net
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "pgrep", "rsync"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # SSH Server - Remote Commands to Clients
  # =============================================================================
  ssh:
    build:
      context: ./containers/ssh
      dockerfile: Dockerfile
    container_name: linbo-ssh
    ports:
      - "2222:2222"
    volumes:
      - linbo_srv_data:/srv/linbo
      - linbo_config:/etc/linuxmuster/linbo
      - ./scripts/server:/usr/share/linuxmuster/linbo
      - linbo_log:/var/log/linuxmuster/linbo
    environment:
      - LINBO_SERVER_IP=${LINBO_SERVER_IP:-10.0.0.1}
    networks:
      - linbo-net
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "pgrep", "sshd"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # PostgreSQL Database
  # =============================================================================
  db:
    image: postgres:15-alpine
    container_name: linbo-db
    volumes:
      - linbo_postgres_data:/var/lib/postgresql/data
      - ./config/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      - POSTGRES_DB=linbo
      - POSTGRES_USER=linbo
      - POSTGRES_PASSWORD=${DB_PASSWORD:-linbo_secret_password}
    networks:
      - linbo-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U linbo"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # Redis Cache
  # =============================================================================
  cache:
    image: redis:7-alpine
    container_name: linbo-cache
    ports:
      - "${REDIS_EXTERNAL_PORT:-6379}:6379"
    volumes:
      - linbo_redis_data:/data
    networks:
      - linbo-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # API Backend (Node.js)
  # =============================================================================
  api:
    build:
      context: ./containers/api
      dockerfile: Dockerfile
    container_name: linbo-api
    ports:
      - "${API_PORT:-3000}:3000"
    volumes:
      - linbo_srv_data:/srv/linbo
      - linbo_config:/etc/linuxmuster/linbo
      - linbo_log:/var/log/linuxmuster/linbo
      - linbo_kernel_data:/var/lib/linuxmuster/linbo
      - ./scripts/server:/usr/share/linuxmuster/linbo
    environment:
      # Server
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - HOST=0.0.0.0
      # Database (Prisma)
      - DATABASE_URL=postgresql://linbo:${DB_PASSWORD:-linbo_secret_password}@linbo-db:5432/linbo?schema=public
      # Redis
      - REDIS_HOST=linbo-cache
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      # Authentication
      - JWT_SECRET=${JWT_SECRET:-your_jwt_secret_here_change_in_production}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      # SSH (for remote commands)
      - SSH_HOST=linbo-ssh
      - SSH_PORT=22
      - SSH_USER=root
      - SSH_PRIVATE_KEY=/etc/linuxmuster/linbo/ssh_host_rsa_key
      - SSH_TIMEOUT=${SSH_TIMEOUT:-10000}
      # Storage paths
      - LINBO_DATA_DIR=/srv/linbo
      - IMAGES_DIR=/srv/linbo/images
      - LINBO_CONFIG_DIR=/etc/linuxmuster/linbo
      - LINBO_LOG_DIR=/var/log/linuxmuster/linbo
      # Server IP (for clients)
      - LINBO_SERVER_IP=${LINBO_SERVER_IP:-10.0.0.1}
      # DHCP / Network
      - LINBO_SUBNET=${LINBO_SUBNET:-10.0.0.0}
      - LINBO_NETMASK=${LINBO_NETMASK:-255.255.0.0}
      - LINBO_GATEWAY=${LINBO_GATEWAY:-10.0.0.254}
      - LINBO_DNS=${LINBO_DNS:-10.0.0.1}
      - LINBO_DOMAIN=${LINBO_DOMAIN:-linuxmuster.lan}
      # Features
      - ENABLE_AUDIT_LOG=${ENABLE_AUDIT_LOG:-true}
      # DC Provisioning (Phase 11)
      - DC_PROVISIONING_ENABLED=${DC_PROVISIONING_ENABLED:-false}
      - DC_PROVISIONING_DRYRUN=${DC_PROVISIONING_DRYRUN:-true}
      - CSV_COL0_SOURCE=${CSV_COL0_SOURCE:-room}
      # Internal API key (container-to-container auth)
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-linbo-internal-secret}
      # HTTP Boot
      - WEB_PORT=${WEB_PORT:-8080}
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      # Host Status Worker
      - HOST_OFFLINE_TIMEOUT_SEC=${HOST_OFFLINE_TIMEOUT_SEC:-300}
      - HOST_SCAN_ENABLED=${HOST_SCAN_ENABLED:-true}
      - HOST_SCAN_INTERVAL_SEC=${HOST_SCAN_INTERVAL_SEC:-60}
      - HOST_SCAN_CONCURRENCY=${HOST_SCAN_CONCURRENCY:-30}
      - HOST_SCAN_PORT_TIMEOUT_MS=${HOST_SCAN_PORT_TIMEOUT_MS:-500}
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy
      ssh:
        condition: service_started
      init:
        condition: service_completed_successfully
    networks:
      - linbo-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # =============================================================================
  # Web Frontend (React + Nginx)
  # =============================================================================
  web:
    build:
      context: ./containers/web
      dockerfile: Dockerfile
      args:
        GIT_HASH: ${GIT_HASH:-dev}
    container_name: linbo-web
    ports:
      - "${WEB_PORT:-8080}:80"
    volumes:
      - linbo_srv_data:/srv/linbo:ro
    depends_on:
      api:
        condition: service_healthy
    networks:
      - linbo-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =============================================================================
  # DHCP Proxy (Optional - start with: docker compose --profile dhcp up -d)
  # =============================================================================
  dhcp:
    build: ./containers/dhcp
    container_name: linbo-dhcp
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - linbo_srv_data:/srv/linbo:ro
    environment:
      - API_URL=http://localhost:${API_PORT:-3000}
      - LINBO_SERVER_IP=${LINBO_SERVER_IP:-10.0.0.1}
      - DHCP_INTERFACE=${DHCP_INTERFACE:-eth0}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-linbo-internal-secret}
      - API_TOKEN=${DHCP_API_TOKEN:-}
    depends_on:
      api:
        condition: service_healthy
    profiles: ["dhcp"]
    restart: unless-stopped

# =============================================================================
# Volumes
# =============================================================================
volumes:
  linbo_srv_data:
    name: linbo_srv_data
  linbo_config:
    name: linbo_config
  linbo_log:
    name: linbo_log
  linbo_postgres_data:
    name: linbo_postgres_data
  linbo_redis_data:
    name: linbo_redis_data
  linbo_kernel_data:
    name: linbo_kernel_data

# =============================================================================
# Networks
# =============================================================================
networks:
  linbo-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
