# GitHub Actions Workflow: Update LINBO Boot Files
#
# This workflow:
# 1. Checks weekly for new linuxmuster-linbo7 releases
# 2. Downloads the latest version
# 3. Extracts boot files
# 4. Creates a new release with linbo-boot-files.tar.gz
#
# Can also be triggered manually via workflow_dispatch

name: Update Boot Files

on:
  # Run weekly on Sunday at 2:00 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version unchanged'
        required: false
        default: 'false'
        type: boolean

env:
  LINBO_REPO: "linuxmuster/linuxmuster-linbo7"
  LINBO_DEB_BASE: "https://deb.linuxmuster.net"
  LINBO_DEB_DIST: "lmn73"

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest LINBO version
        id: linbo-version
        run: |
          # Get latest version from APT Packages file
          PACKAGES_URL="${LINBO_DEB_BASE}/dists/${LINBO_DEB_DIST}/main/binary-amd64/Packages"
          echo "Fetching package index: $PACKAGES_URL"

          # Try compressed first, then plain
          PACKAGES=$(curl -sL "${PACKAGES_URL}.gz" | gunzip 2>/dev/null || curl -sL "$PACKAGES_URL")

          # Extract linuxmuster-linbo7 package info
          VERSION=$(echo "$PACKAGES" | awk '/^Package: linuxmuster-linbo7$/,/^$/' | grep "^Version:" | tail -1 | awk '{print $2}')
          FILENAME=$(echo "$PACKAGES" | awk '/^Package: linuxmuster-linbo7$/,/^$/' | grep "^Filename:" | tail -1 | awk '{print $2}')

          if [ -z "$VERSION" ] || [ -z "$FILENAME" ]; then
            echo "ERROR: Could not find LINBO package in APT repo"
            echo "Tried: $PACKAGES_URL"
            exit 1
          fi

          DEB_URL="${LINBO_DEB_BASE}/${FILENAME}"
          echo "Latest LINBO version: $VERSION"
          echo "Deb URL: $DEB_URL"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "deb_url=$DEB_URL" >> $GITHUB_OUTPUT

      - name: Check current version
        id: current-version
        run: |
          # Check if we already have this version
          CURRENT_VERSION=""
          if [ -f "boot-files/VERSION" ]; then
            CURRENT_VERSION=$(cat boot-files/VERSION)
          fi

          echo "Current version: $CURRENT_VERSION"
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          if [ "$CURRENT_VERSION" = "${{ steps.linbo-version.outputs.version }}" ] && [ "${{ inputs.force_update }}" != "true" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Version unchanged, skipping update"
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update needed"
          fi

      - name: Download and extract LINBO package
        if: steps.current-version.outputs.needs_update == 'true'
        run: |
          mkdir -p work boot-files
          cd work

          # Download the deb package
          DEB_URL="${{ steps.linbo-version.outputs.deb_url }}"
          DEB_FILE=$(basename "$DEB_URL")
          echo "Downloading $DEB_FILE..."
          wget -q "$DEB_URL"

          # Extract deb
          echo "Extracting package..."
          dpkg-deb -x "$DEB_FILE" extracted/

          # Copy boot files
          echo "Copying boot files..."

          # GRUB files
          mkdir -p ../boot-files/boot/grub
          if [ -d "extracted/srv/linbo/boot/grub" ]; then
            cp -r extracted/srv/linbo/boot/grub/* ../boot-files/boot/grub/
          fi

          # Icons (themes)
          mkdir -p ../boot-files/icons
          if [ -d "extracted/srv/linbo/boot/grub/themes/linbo/icons" ]; then
            cp -r extracted/srv/linbo/boot/grub/themes/linbo/icons/* ../boot-files/icons/ 2>/dev/null || true
          fi
          cp -r extracted/srv/linbo/icons/* ../boot-files/icons/ 2>/dev/null || true

          # Kernel variants (stable, longterm, legacy)
          echo "Extracting kernel variants..."
          mkdir -p ../boot-files/kernels
          for variant in stable longterm legacy; do
            src="extracted/var/lib/linuxmuster/linbo/$variant"
            if [ -d "$src" ]; then
              mkdir -p "../boot-files/kernels/$variant"
              cp "$src/linbo64" "../boot-files/kernels/$variant/" 2>/dev/null || true
              cp "$src/modules.tar.xz" "../boot-files/kernels/$variant/" 2>/dev/null || true
              cp "$src/version" "../boot-files/kernels/$variant/" 2>/dev/null || true
              echo "  - $variant: $(cat "$src/version" 2>/dev/null || echo 'unknown')"
            else
              echo "  - $variant: not found in package"
            fi
          done

          # linbofs64.xz template (base without modules)
          if [ -f "extracted/var/lib/linuxmuster/linbo/linbofs64.xz" ]; then
            cp "extracted/var/lib/linuxmuster/linbo/linbofs64.xz" ../boot-files/
            echo "  - linbofs64.xz template copied"
          fi

          # Generate manifest.json with checksums
          VERSION="${{ steps.linbo-version.outputs.version }}"
          python3 -c "
          import json, hashlib, os
          manifest = {'variants': {}, 'linboVersion': '$VERSION'}
          for v in ['stable','longterm','legacy']:
              d = f'../boot-files/kernels/{v}'
              if os.path.isdir(d):
                  entry = {}
                  for f in ['linbo64','modules.tar.xz','version']:
                      fp = os.path.join(d, f)
                      if os.path.isfile(fp):
                          entry[f] = {
                              'size': os.path.getsize(fp),
                              'sha256': hashlib.sha256(open(fp,'rb').read()).hexdigest()
                          }
                          if f == 'version':
                              entry['kernelVersion'] = open(fp).read().strip()
                  manifest['variants'][v] = entry
          tp = '../boot-files/linbofs64.xz'
          if os.path.isfile(tp):
              manifest['template'] = {
                  'size': os.path.getsize(tp),
                  'sha256': hashlib.sha256(open(tp,'rb').read()).hexdigest()
              }
          json.dump(manifest, open('../boot-files/kernels/manifest.json','w'), indent=2)
          print('  - manifest.json generated')
          "

          # Build default linbo64 + linbofs64 from stable variant + template
          echo ""
          echo "Building default boot files from stable variant..."
          STABLE_DIR="../boot-files/kernels/stable"
          TEMPLATE="../boot-files/linbofs64.xz"

          # linbo64: copy from stable variant
          if [ -f "$STABLE_DIR/linbo64" ]; then
            cp "$STABLE_DIR/linbo64" ../boot-files/linbo64
            echo "  - linbo64 copied from stable variant"
          else
            echo "WARNING: No stable/linbo64 found — linbo64 will be missing!"
          fi

          # linbofs64: build from template + stable modules
          BOOT_ABS="$(cd .. && pwd)/boot-files"
          if [ -f "$BOOT_ABS/linbofs64.xz" ] && [ -f "$BOOT_ABS/kernels/stable/modules.tar.xz" ]; then
            echo "  Building linbofs64 from template + stable modules..."
            BUILDDIR=$(mktemp -d)

            # Extract template
            xzcat "$BOOT_ABS/linbofs64.xz" | (cd "$BUILDDIR" && cpio -i -d -H newc --no-absolute-filenames 2>/dev/null || true)

            # Clean old modules and inject stable variant's modules
            rm -rf "$BUILDDIR/lib/modules"
            mkdir -p "$BUILDDIR/lib/modules"
            tar xf "$BOOT_ABS/kernels/stable/modules.tar.xz" -C "$BUILDDIR"

            # Run depmod if a single module dir exists
            MOD_KVER=$(ls -d "$BUILDDIR/lib/modules"/*/ 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "")
            if [ -n "$MOD_KVER" ] && command -v depmod &>/dev/null; then
              depmod -a -b "$BUILDDIR" "$MOD_KVER" 2>/dev/null || true
            fi

            # Repack as linbofs64 (uncompressed cpio — this is what GRUB loads)
            (cd "$BUILDDIR" && find . -print0 | cpio -o -0 -H newc 2>/dev/null) > "$BOOT_ABS/linbofs64"
            echo "  - linbofs64 built ($(du -h "$BOOT_ABS/linbofs64" | cut -f1))"

            rm -rf "$BUILDDIR"
          else
            echo "WARNING: Cannot build linbofs64 — template or stable modules missing"
          fi

          # Write version file
          echo "${{ steps.linbo-version.outputs.version }}" > ../boot-files/VERSION

          # Cleanup
          cd ..
          rm -rf work

          echo "Boot files extracted successfully"
          ls -la boot-files/
          echo "Kernel variants:"
          ls -la boot-files/kernels/ 2>/dev/null || echo "  (none)"

      - name: Create boot files archive
        if: steps.current-version.outputs.needs_update == 'true'
        run: |
          cd boot-files
          tar -czvf ../linbo-boot-files.tar.gz .
          cd ..

          # Calculate checksum
          sha256sum linbo-boot-files.tar.gz > linbo-boot-files.tar.gz.sha256

          echo "Archive created:"
          ls -lh linbo-boot-files.tar.gz*

      - name: Create Release
        if: steps.current-version.outputs.needs_update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: boot-files-${{ steps.linbo-version.outputs.version }}
          name: LINBO Boot Files ${{ steps.linbo-version.outputs.version }}
          body: |
            ## LINBO Boot Files

            Based on linuxmuster-linbo7 version **${{ steps.linbo-version.outputs.version }}**

            ### Contents
            - `linbo64` - LINBO Linux kernel (from stable variant)
            - `linbofs64` - LINBO initramfs (built from template + stable modules)
            - `linbofs64.xz` - LINBO initramfs template (base without modules)
            - `boot/grub/` - GRUB bootloader files
            - `icons/` - OS icons for LINBO GUI
            - `kernels/` - Kernel variants (stable, longterm, legacy)
            - `kernels/manifest.json` - Checksums and version info

            ### Usage
            These files are automatically downloaded by the linbo-init container on first start.

            Manual download:
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/boot-files-${{ steps.linbo-version.outputs.version }}/linbo-boot-files.tar.gz
            tar -xzf linbo-boot-files.tar.gz -C /srv/linbo/
            ```

            ### Source
            Original package: [linuxmuster-linbo7](https://github.com/linuxmuster/linuxmuster-linbo7)
            License: GPL-3.0
          files: |
            linbo-boot-files.tar.gz
            linbo-boot-files.tar.gz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release pointer
        if: steps.current-version.outputs.needs_update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Boot Files
          body: |
            Latest LINBO boot files (version ${{ steps.linbo-version.outputs.version }})

            This release always points to the most recent boot files.
          files: |
            linbo-boot-files.tar.gz
            linbo-boot-files.tar.gz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Boot Files Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **LINBO Version:** ${{ steps.linbo-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version:** ${{ steps.current-version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Performed:** ${{ steps.current-version.outputs.needs_update }}" >> $GITHUB_STEP_SUMMARY
