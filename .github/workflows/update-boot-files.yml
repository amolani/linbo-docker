# GitHub Actions Workflow: Update LINBO Boot Files
#
# This workflow:
# 1. Checks weekly for new linuxmuster-linbo7 releases
# 2. Downloads the latest version
# 3. Extracts boot files
# 4. Creates a new release with linbo-boot-files.tar.gz
#
# Can also be triggered manually via workflow_dispatch

name: Update Boot Files

on:
  # Run weekly on Sunday at 2:00 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version unchanged'
        required: false
        default: 'false'
        type: boolean

env:
  LINBO_REPO: "linuxmuster/linuxmuster-linbo7"
  LINBO_ARCHIVE_URL: "https://archive.linuxmuster.net/lmn73"

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest LINBO version
        id: linbo-version
        run: |
          # Get latest version from linuxmuster archive
          LATEST_DEB=$(curl -sL "${LINBO_ARCHIVE_URL}/" | grep -oP 'linuxmuster-linbo7_[0-9.]+-[0-9]+_all\.deb' | sort -V | tail -1)

          if [ -z "$LATEST_DEB" ]; then
            echo "ERROR: Could not find LINBO package"
            exit 1
          fi

          VERSION=$(echo "$LATEST_DEB" | grep -oP '[0-9.]+-[0-9]+')
          echo "Latest LINBO version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "deb_file=$LATEST_DEB" >> $GITHUB_OUTPUT

      - name: Check current version
        id: current-version
        run: |
          # Check if we already have this version
          CURRENT_VERSION=""
          if [ -f "boot-files/VERSION" ]; then
            CURRENT_VERSION=$(cat boot-files/VERSION)
          fi

          echo "Current version: $CURRENT_VERSION"
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          if [ "$CURRENT_VERSION" = "${{ steps.linbo-version.outputs.version }}" ] && [ "${{ inputs.force_update }}" != "true" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Version unchanged, skipping update"
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update needed"
          fi

      - name: Download and extract LINBO package
        if: steps.current-version.outputs.needs_update == 'true'
        run: |
          mkdir -p work boot-files
          cd work

          # Download the deb package
          echo "Downloading ${{ steps.linbo-version.outputs.deb_file }}..."
          wget -q "${LINBO_ARCHIVE_URL}/${{ steps.linbo-version.outputs.deb_file }}"

          # Extract deb
          echo "Extracting package..."
          dpkg-deb -x "${{ steps.linbo-version.outputs.deb_file }}" extracted/

          # Copy boot files
          echo "Copying boot files..."

          # Kernel and initramfs
          cp extracted/srv/linbo/linbo64 ../boot-files/
          cp extracted/srv/linbo/linbofs64 ../boot-files/

          # GRUB files
          mkdir -p ../boot-files/boot/grub
          cp -r extracted/srv/linbo/boot/grub/* ../boot-files/boot/grub/

          # Icons
          mkdir -p ../boot-files/icons
          cp -r extracted/srv/linbo/icons/* ../boot-files/icons/ 2>/dev/null || true

          # Kernel variants (stable, longterm, legacy)
          echo "Extracting kernel variants..."
          mkdir -p ../boot-files/kernels
          for variant in stable longterm legacy; do
            src="extracted/var/lib/linuxmuster/linbo/$variant"
            if [ -d "$src" ]; then
              mkdir -p "../boot-files/kernels/$variant"
              cp "$src/linbo64" "../boot-files/kernels/$variant/" 2>/dev/null || true
              cp "$src/modules.tar.xz" "../boot-files/kernels/$variant/" 2>/dev/null || true
              cp "$src/version" "../boot-files/kernels/$variant/" 2>/dev/null || true
              echo "  - $variant: $(cat "$src/version" 2>/dev/null || echo 'unknown')"
            else
              echo "  - $variant: not found in package"
            fi
          done

          # linbofs64.xz template (base without modules)
          if [ -f "extracted/var/lib/linuxmuster/linbo/linbofs64.xz" ]; then
            cp "extracted/var/lib/linuxmuster/linbo/linbofs64.xz" ../boot-files/
            echo "  - linbofs64.xz template copied"
          fi

          # Generate manifest.json with checksums
          VERSION="${{ steps.linbo-version.outputs.version }}"
          python3 -c "
          import json, hashlib, os
          manifest = {'variants': {}, 'linboVersion': '$VERSION'}
          for v in ['stable','longterm','legacy']:
              d = f'../boot-files/kernels/{v}'
              if os.path.isdir(d):
                  entry = {}
                  for f in ['linbo64','modules.tar.xz','version']:
                      fp = os.path.join(d, f)
                      if os.path.isfile(fp):
                          entry[f] = {
                              'size': os.path.getsize(fp),
                              'sha256': hashlib.sha256(open(fp,'rb').read()).hexdigest()
                          }
                          if f == 'version':
                              entry['kernelVersion'] = open(fp).read().strip()
                  manifest['variants'][v] = entry
          tp = '../boot-files/linbofs64.xz'
          if os.path.isfile(tp):
              manifest['template'] = {
                  'size': os.path.getsize(tp),
                  'sha256': hashlib.sha256(open(tp,'rb').read()).hexdigest()
              }
          json.dump(manifest, open('../boot-files/kernels/manifest.json','w'), indent=2)
          print('  - manifest.json generated')
          "

          # Write version file
          echo "${{ steps.linbo-version.outputs.version }}" > ../boot-files/VERSION

          # Cleanup
          cd ..
          rm -rf work

          echo "Boot files extracted successfully"
          ls -la boot-files/
          echo "Kernel variants:"
          ls -la boot-files/kernels/ 2>/dev/null || echo "  (none)"

      - name: Create boot files archive
        if: steps.current-version.outputs.needs_update == 'true'
        run: |
          cd boot-files
          tar -czvf ../linbo-boot-files.tar.gz .
          cd ..

          # Calculate checksum
          sha256sum linbo-boot-files.tar.gz > linbo-boot-files.tar.gz.sha256

          echo "Archive created:"
          ls -lh linbo-boot-files.tar.gz*

      - name: Create Release
        if: steps.current-version.outputs.needs_update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: boot-files-${{ steps.linbo-version.outputs.version }}
          name: LINBO Boot Files ${{ steps.linbo-version.outputs.version }}
          body: |
            ## LINBO Boot Files

            Based on linuxmuster-linbo7 version **${{ steps.linbo-version.outputs.version }}**

            ### Contents
            - `linbo64` - LINBO Linux kernel
            - `linbofs64` - LINBO initramfs
            - `linbofs64.xz` - LINBO initramfs template (without modules)
            - `boot/grub/` - GRUB bootloader files
            - `icons/` - OS icons for LINBO GUI
            - `kernels/` - Kernel variants (stable, longterm, legacy)
            - `kernels/manifest.json` - Checksums and version info

            ### Usage
            These files are automatically downloaded by the linbo-init container on first start.

            Manual download:
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/boot-files-${{ steps.linbo-version.outputs.version }}/linbo-boot-files.tar.gz
            tar -xzf linbo-boot-files.tar.gz -C /srv/linbo/
            ```

            ### Source
            Original package: [linuxmuster-linbo7](https://github.com/linuxmuster/linuxmuster-linbo7)
            License: GPL-3.0
          files: |
            linbo-boot-files.tar.gz
            linbo-boot-files.tar.gz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release pointer
        if: steps.current-version.outputs.needs_update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Boot Files
          body: |
            Latest LINBO boot files (version ${{ steps.linbo-version.outputs.version }})

            This release always points to the most recent boot files.
          files: |
            linbo-boot-files.tar.gz
            linbo-boot-files.tar.gz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Boot Files Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **LINBO Version:** ${{ steps.linbo-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version:** ${{ steps.current-version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Performed:** ${{ steps.current-version.outputs.needs_update }}" >> $GITHUB_STEP_SUMMARY
