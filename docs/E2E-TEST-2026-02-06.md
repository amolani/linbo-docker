# End-to-End Test Session - 2026-02-06

**Umgebung:**
- Produktionsserver (AD DC): 10.0.0.11 (linuxmuster.net 7.3)
- Test-VM (Docker-Stack): 10.0.0.13
- Test-Client: 10.0.150.1 (MAC: bc:24:11:a4:d2:ea)

**Ziel:** Kompletten PXE-Boot-Workflow validieren: Config erstellen → Host anlegen → Provisioning → PXE Boot → LINBO-Client erhalt start.conf

---

## 1. Vorbereitung: Test-VM synchronisieren

### Aktion
- Test-VM von Commit `da7ce31` auf `3276e00` aktualisiert (2 Commits)
- `.env` von Produktion kopiert, `LINBO_SERVER_IP=10.0.0.13` angepasst
- Provisioning aktiviert: `DC_PROVISIONING_ENABLED=true`, `DC_PROVISIONING_DRYRUN=false`
- Alle 8 Container neu gebaut: `docker compose up -d --build`

### Ergebnis
Alle 8 Container healthy.

---

## 2. Config erstellen: "amodrei"

### Aktion
Im Frontend eine Config "amodrei" erstellt mit:
- 4 Partitionen (EFI, MSR, Windows, Data)
- 1 OS-Eintrag (Windows 11 Education)
- SystemType: efi64

### Verifikation
```bash
# start.conf deployed
docker exec linbo-rsync cat /srv/linbo/start.conf.amodrei
# → [LINBO] Section mit Server=10.0.0.13, Cache=/dev/sda4

# GRUB Config generiert
docker exec linbo-rsync cat /srv/linbo/boot/grub/amodrei.cfg
# → 5 Menueintraege: sync+start, sync, start, new, info

# Hauptboot-Chain korrekt
docker exec linbo-rsync cat /srv/linbo/boot/grub/grub.cfg
# → hostcfg/$net_default_hostname.cfg → group.cfg → Fallback
```

### Ergebnis: PASS

---

## 3. Host erstellen: "amodreiPC"

### Aktion
Host erstellt mit:
- Hostname: amodreiPC
- IP: 10.0.150.1
- MAC: bc:24:11:a4:d2:ea
- Config: amodrei

### Verifikation
```bash
# IP-Symlink existiert
docker exec linbo-rsync ls -la /srv/linbo/start.conf-10.0.150.1
# → start.conf-10.0.150.1 -> start.conf.amodrei ✓

# Host-GRUB Symlink existiert
docker exec linbo-rsync ls -la /srv/linbo/boot/grub/hostcfg/amodreiPC.cfg
# → amodreiPC.cfg -> ../amodrei.cfg ✓
```

### Ergebnis: PASS

---

## 4. Provisioning via DC Worker

### Problem
Beim Erstellen des Hosts wurde kein Provisioning-Badge angezeigt.

### Ursache
`DC_PROVISIONING_ENABLED=false` in `.env` (aus Produktion kopiert).

### Fix
```bash
# In .env auf Test-VM:
DC_PROVISIONING_ENABLED=true
DC_PROVISIONING_DRYRUN=false

# WICHTIG: up -d statt restart!
docker compose up -d api
```

### DC Worker auf Produktionsserver starten
Der DC Worker muss auf dem AD DC laufen (Zugriff auf samba-tool, linuxmuster-import-devices):
```bash
# Config: /etc/linbo-docker/macct-worker.conf
REDIS_HOST=10.0.0.13
REDIS_PORT=6379
API_URL=http://10.0.0.13:3000/api/v1
API_KEY=linbo-internal-secret

# Starten
python3 /root/linbo-docker/dc-worker/macct-worker.py \
  --config /etc/linbo-docker/macct-worker.conf
```

### Worker-Log
```
[INFO] Processing job: bc44edb4-... (type=provision_host)
[INFO] [Provision] Batch: 1 provision jobs, 0 deferred
[INFO] [Provision] Wrote merged devices.csv (38 lines)
[INFO] [Provision] Running /usr/sbin/linuxmuster-import-devices
[INFO] [Provision] import-devices completed successfully
[INFO] [Provision] Batch complete: 1 verified OK, 0 failed verify
```

### Ergebnis
- Host provisionStatus: `synced`
- AD-Computerobjekt erstellt
- DNS A-Record erstellt
- devices.csv aktualisiert

### Ergebnis: PASS

---

## 5. PXE Boot - Erster Versuch (FAIL)

### Problem
Client bootete via PXE, GRUB lud korrekt, aber LINBO zeigte falsche start.conf:
- `Server = 10.0.0.11` (Produktion) statt `10.0.0.13` (Test-VM)
- Ursache: Client bekam Fallback-start.conf weil rsync nicht antwortete

### Diagnose
```bash
# Auf Produktionsserver:
linbo-ssh 10.0.150.1

# Kernel cmdline zeigte korrekten Server
cat /proc/cmdline
# → server=10.0.0.13 ✓

# Aber start.conf war falsch
cat /start.conf
# → Server = 10.0.0.11 (Fallback!)
```

### Root Cause
rsync Container-Logs zeigten:
```
sh: 1: /usr/share/linuxmuster/linbo/rsync-pre-download-api.sh: not found
pre-xfer exec returned failure (32512)
```

Die Hook-Scripts fehlten im rsync Container (Dockerfile kopierte sie nicht). Da `pre-xfer exec` fehlschlug, lehnte rsync **ALLE** Verbindungen ab. Der Client konnte keine start.conf via rsync holen und verwendete eine im Cache vorhandene Datei (vom Produktionsserver).

---

## 6. Rsync Fix (Commit bbf747c)

### Aenderungen
1. `containers/rsync/Dockerfile` erweitert:
   - `curl` installiert (fuer API-Hooks)
   - `COPY scripts/ /usr/share/linuxmuster/linbo/` hinzugefuegt
   - `chmod +x` auf alle Scripts

2. `containers/rsync/scripts/` erstellt mit 4 Hook-Scripts:
   - `rsync-pre-download-api.sh`
   - `rsync-post-download-api.sh`
   - `rsync-pre-upload-api.sh`
   - `rsync-post-upload-api.sh`

### Deployment auf Test-VM
```bash
git pull
docker compose up -d --build rsync
```

### Verifikation
```bash
rsync --list-only rsync://10.0.0.13/linbo/start.conf.amodrei
# → -rw-r--r-- 755 2026/02/06 18:22:10 start.conf.amodrei ✓
```

---

## 7. PXE Boot - Zweiter Versuch (PASS)

### Ergebnis
- GRUB lud korrekt von TFTP
- `hostcfg/amodreiPC.cfg` → `amodrei.cfg` aufgeloest
- LINBO Kernel + initrd geladen
- rsync Verbindung zu 10.0.0.13 erfolgreich
- `start.conf.amodrei` korrekt mit `Server = 10.0.0.13`
- LINBO GUI zeigte Windows 11 OS-Eintrag
- Alle nativen Funktionen (Partitionierung, Sync, Start) verfuegbar

---

## PXE Boot Chain (verifiziert)

```
┌─────────────────────────────────────────────────────┐
│ 1. DHCP    → Client erhaelt IP + next-server        │
│ 2. TFTP    → GRUB Bootloader (core.efi)             │
│ 3. GRUB    → grub.cfg → hostcfg/amodreiPC.cfg       │
│             → ../amodrei.cfg (Symlink)               │
│ 4. GRUB    → linbo64 + linbofs64 (Kernel + initrd)  │
│ 5. LINBO   → rsync 10.0.0.13::linbo/start.conf.*   │
│ 6. LINBO   → GUI mit OS-Eintraegen                  │
│ 7. Nativ   → Partition/Sync/Start (linbo64 built-in)│
└─────────────────────────────────────────────────────┘
```

---

## Gefundene Bugs

| # | Bug | Schweregrad | Fix |
|---|-----|-------------|-----|
| 1 | rsync Hook-Scripts fehlen im Container | KRITISCH | Dockerfile + scripts/ (bbf747c) |
| 2 | `docker compose restart` laedt keine ENV-Vars | Mittel | Immer `up -d` verwenden |
| 3 | `DC_PROVISIONING_ENABLED=false` nach .env-Kopie | Niedrig | Manuell in .env aendern |

---

## Fazit

Der komplette PXE-Boot-Workflow funktioniert End-to-End:
- Config-Erstellung → GRUB-Generierung → Host-Anlage → Symlink-Erstellung
- Provisioning via DC Worker (AD + DNS + devices.csv)
- PXE Boot → TFTP → GRUB → LINBO → rsync → start.conf

**Kritischer Bug behoben:** rsync Container hatte keine Hook-Scripts, was alle rsync-Verbindungen blockierte. Fix in Commit `bbf747c`.

Die nativen LINBO-Funktionen (Partitionierung, Image-Sync, OS-Start) werden direkt von linbo64/linbofs64 bereitgestellt und benoetigen keine Docker-seitige Implementierung.
